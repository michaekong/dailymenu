<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Menu Restaurant - Interface Client</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap');

:root {
    /* Couleurs de base - ajustées */
    --rouge-brique: #8B2323;   /* Rouge principal profond */
    --rouge-doux: #A24E4E;     /* Rouge plus clair pour les accents */
    --rouge-vif: #E53935;      /* Nouveau: Rouge plus vibrant pour les CTA/flags */
    --rose-pale: #E7D3D3;      /* Couleur de texte clair, éléments de fond doux */
    --jaune-creme: #FFF1CF;    /* Accents, fonds d'icônes, éléments lumineux */
    --jaune-moutarde: #FBC02D; /* Nouveau: Jaune plus profond pour certains flags */

    /* Couleurs dérivées pour le design */
    --text-dark: #2C1A1A; /* Texte principal sombre */
    --text-light: #E7D3D3; /* Texte sur fonds sombres */
    --background-light: #F8F4F4; /* Fond général très clair */
    --card-background: #FFFFFF; /* Fond des cartes */
    --sidebar-background: rgba(44, 26, 26, 0.95); /* Fond de la barre latérale - plus opaque */
    --border-color: rgba(139, 35, 35, 0.1); /* Bordures subtiles */
    --shadow-light: rgba(0, 0, 0, 0.08);
    --shadow-medium: rgba(0, 0, 0, 0.15);
    --shadow-dark: rgba(0, 0, 0, 0.25);

    /* Glassmorphism */
    --glass-effect-dark: rgba(0, 0, 0, 0.2); /* Pour les éléments sombres */
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);

    /* Font sizes */
    --font-xl: 3.2rem; /* Légèrement plus grand pour les titres */
    --font-lg: 2.4rem;
    --font-md: 1.6rem;
    --font-sm: 1.2rem;
    --font-xs: 1rem;
    --font-xxs: 0.85rem;
}

/* --- Généralités & Base --- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: 'Montserrat', sans-serif; /* Nouvelle police pour le corps de texte */
    background: linear-gradient(135deg, var(--rose-pale), var(--background-light));
    min-height: 100vh;
    color: var(--text-dark);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 0;
    overflow-x: hidden;
}

/* --- Layout Principal --- */
.main-wrapper {
    display: flex;
    width: 100%;
    max-width: 1400px;
    min-height: 100vh;
    background: var(--background-light);
    box-shadow: 0 0 30px var(--shadow-dark);
    overflow: hidden;
}

/* --- Barre Latérale (Sidebar) --- */
.sidebar {
    width: 300px;
    background: var(--sidebar-background);
    backdrop-filter: blur(15px);
    color: var(--text-light);
    padding: 30px 20px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    border-right: var(--glass-border);
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
    flex-shrink: 0;
}

.sidebar .header .logo-title {
    font-family: 'Playfair Display', serif; /* Nouvelle police pour les titres principaux */
    font-size: var(--font-lg);
    margin-bottom: 5px;
    color: var(--jaune-creme);
    text-shadow: 1px 1px 3px var(--text-dark);
    font-weight: 700;
}

.sidebar .header p {
    font-size: var(--font-xxs); /* Taille légèrement réduite */
    opacity: 0.8;
}

.etablissement-info-card,
.qr-section {
    background: var(--glass-effect-dark);
    border-radius: 12px;
    padding: 20px;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
    border: var(--glass-border);
}

.etablissement-info-card h3,
.qr-section h3 {
    font-size: var(--font-sm);
    margin-bottom: 15px;
    color: var(--rose-pale);
    display: flex;
    align-items: center;
    font-weight: 600; /* Plus de poids */
}
.etablissement-info-card h3 .fas,
.qr-section h3 .fas {
    margin-right: 10px;
    color: var(--rouge-vif); /* Icônes en rouge vif */
}

.etablissement-info-card p {
    font-size: 0.9rem; /* Légèrement plus grand */
    line-height: 1.6;
    color: rgba(231, 211, 211, 0.85);
    margin-bottom: 8px;
}
.etablissement-info-card p .fas {
    margin-right: 8px;
    color: var(--rouge-doux);
}

.qr-code {
    width: 150px;
    height: 150px;
    background: var(--jaune-creme);
    border-radius: 8px;
    margin: 15px auto 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--rouge-brique);
    box-shadow: 0 5px 15px var(--shadow-dark);
    overflow: hidden;
}
.qr-code img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* --- Zone de Contenu Principal (Main Content) --- */
.content-area {
    flex-grow: 1;
    background: var(--background-light);
    position: relative;
    z-index: 1;
    padding-bottom: 50px;
}

/* --- Top Banner (Inspiré Nando's) --- */
.top-banner {
    background: linear-gradient(135deg, var(--rouge-brique) 0%, var(--rouge-doux) 100%);
    color: white;
    padding: 60px 20px;
    text-align: center;
    box-shadow: 0 5px 20px var(--shadow-dark);
    margin-bottom: 30px;
}
.top-banner .vcenter {
    max-width: 800px;
    margin: 0 auto;
}
.top-banner h1 {
    font-family: 'Playfair Display', serif; /* Police principale de titre */
    font-size: var(--font-xl);
    margin-bottom: 10px;
    text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    line-height: 1.1; /* Améliore la densité du titre */
}
.top-banner p {
    font-size: var(--font-sm);
    line-height: 1.6;
    opacity: 0.9;
    margin-bottom: 20px;
}
.top-banner .cta-button {
    display: inline-block;
    background: var(--jaune-creme);
    color: var(--rouge-brique);
    padding: 12px 25px;
    border-radius: 30px;
    text-decoration: none;
    font-weight: 700;
    font-size: var(--font-xs);
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px var(--shadow-medium);
}
.top-banner .cta-button:hover {
    background: #FFECB3;
    transform: translateY(-3px);
    box-shadow: 0 6px 15px var(--shadow-dark);
}
.top-banner .cta-button .fas {
    margin-left: 8px;
    font-size: 0.9em;
}

/* --- Sub-Navigation des Catégories (Inspirée Nando's subNav) --- */
.nav-container {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--background-light);
    border-bottom: 1px solid var(--border-color);
    padding: 15px 20px;
    box-shadow: 0 2px 8px var(--shadow-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sub-nav {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    white-space: nowrap;
    padding-bottom: 10px;
    flex-grow: 1;
    margin-right: 15px;
}
.sub-nav::-webkit-scrollbar {
    display: none;
}

.sub-nav .nav-items {
    display: flex;
    gap: 10px;
}

.filter-btn {
    flex-shrink: 0;
    padding: 10px 20px;
    border: 1px solid var(--rouge-doux);
    border-radius: 25px;
    background: transparent;
    color: var(--rouge-brique);
    font-size: var(--font-xxs); /* Taille de police légèrement plus petite pour les filtres */
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
}

.filter-btn:hover {
    background: rgba(162, 78, 78, 0.1);
    border-color: var(--rouge-brique);
    color: var(--rouge-brique);
    transform: translateY(-2px); /* Léger survol */
}

/* Filtre de catégorie actif (un seul) */
.filter-btn[data-filter-type="category"].active {
    background: var(--rouge-brique);
    color: white;
    border-color: var(--rouge-brique);
    box-shadow: 0 3px 10px var(--shadow-medium);
}

/* Filtre allergène actif (peut être multiple) */
.filter-btn[data-filter-type="allergene"].active {
    background: var(--rouge-vif); /* Rouge plus vif pour les allergènes actifs */
    color: white;
    border-color: var(--rouge-vif);
    box-shadow: 0 3px 10px var(--shadow-medium);
}


.filter-toggle {
    display: none;
    text-align: center;
}
.mobile-filter-toggle-btn {
    background: var(--rouge-doux);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: var(--font-xs);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    box-shadow: 0 3px 10px var(--shadow-light);
}
.mobile-filter-toggle-btn .fas {
    margin-right: 8px;
}
.mobile-filter-toggle-btn:hover {
    background: var(--rouge-brique);
    transform: translateY(-2px);
}
.mobile-filter-toggle-btn.active {
    background: var(--rouge-brique);
    box-shadow: 0 3px 10px var(--shadow-medium);
}


/* --- Barre de recherche --- */
.search-container {
    padding: 20px 30px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
}

.search-bar {
    width: 100%;
    padding: 12px 45px 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 25px;
    background: var(--card-background);
    font-size: var(--font-xs);
    color: var(--text-dark);
    box-shadow: 0 2px 8px var(--shadow-light);
    transition: all 0.3s ease;
}

.search-bar::placeholder {
    color: rgba(44, 26, 26, 0.6);
}

.search-bar:focus {
    outline: none;
    border-color: var(--rouge-doux);
    box-shadow: 0 0 15px rgba(162, 78, 78, 0.4);
}

.clear-search-btn {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-dark);
    font-size: 1.1rem;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s ease;
}

.clear-search-btn:hover {
    opacity: 1;
}

/* --- Conteneur des Sections de Menu --- */
#menuSectionsContainer {
    padding: 30px;
}

/* --- Sections de Menu (inspirées Nando's) --- */
.menu-section {
    margin-bottom: 50px; /* Plus d'espace entre les sections */
}

.menu-section h2 {
    font-family: 'Playfair Display', serif; /* Police de titre pour les sections */
    font-size: var(--font-lg);
    color: var(--rouge-brique);
    margin-bottom: 25px;
    text-align: center;
    position: relative;
    padding-bottom: 10px;
    font-weight: 700;
}
.menu-section h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 3px;
    background: var(--rouge-doux);
    border-radius: 2px;
}
.menu-section h2 em {
    font-style: normal;
    background: linear-gradient(45deg, var(--rouge-doux), var(--rouge-brique));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}


/* --- Grille des plats (dans chaque section) --- */
.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 30px; /* Plus d'espace entre les cartes */
}

.dish-card {
    background: var(--card-background);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 5px 20px var(--shadow-light);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    position: relative;
}

.dish-card:hover {
    transform: translateY(-8px); /* Animation plus prononcée */
    box-shadow: 0 15px 35px var(--shadow-medium); /* Ombre plus large */
}

.dish-card.unavailable-item {
    opacity: 0.6;
    pointer-events: none;
    filter: grayscale(80%);
}
.dish-card.unavailable-item .dish-price::before {
    content: 'INDISPONIBLE - ';
    font-size: 0.8em;
    color: var(--rouge-brique);
    font-weight: normal;
}


/* --- Flags (New, Popular, etc.) - Stylisation Ruban --- */
.dish-card .flag {
    position: absolute;
    top: 15px;
    left: -5px; /* Décalé pour l'effet ruban */
    padding: 6px 15px 6px 20px; /* Plus de padding pour l'effet */
    font-size: 0.7rem; /* Taille plus petite */
    font-weight: 700; /* Plus de poids */
    text-transform: uppercase;
    z-index: 10;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
    transform: rotate(-3deg); /* Légère rotation */
    transform-origin: top left;
    clip-path: polygon(0 0, 100% 0, 95% 50%, 100% 100%, 0 100%, 5% 50%); /* Forme de ruban */
    border-top-right-radius: 3px;
    border-bottom-right-radius: 3px;
    transition: transform 0.2s ease;
}
.dish-card:hover .flag {
    transform: rotate(-3deg) scale(1.05); /* Léger zoom au survol de la carte */
}

.dish-card .flag.new {
    background: #4CAF50; /* Vert pour 'New' */
    color: white;
}
.dish-card .flag.featured {
    background: var(--jaune-moutarde); /* Jaune moutarde pour 'POPULAIRE' */
    color: var(--rouge-brique); /* Texte foncé sur jaune */
}

.dish-diet-icons {
    position: absolute;
    bottom: 15px;
    right: 15px;
    display: flex;
    gap: 8px;
}
.dish-diet-icons .diet-icon {
    font-size: 0.8rem; /* Taille plus petite */
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-style: normal;
    text-transform: uppercase;
    font-weight: 600;
    background: rgba(0,0,0,0.5);
    transition: transform 0.2s ease;
}
.dish-diet-icons .diet-icon:hover {
    transform: translateY(-3px); /* Léger survol sur l'icône */
}
.dish-diet-icons .diet-icon.vegetarian {
    background: var(--rouge-doux);
}
.dish-diet-icons .diet-icon.vegan {
    background: #6D983F;
}
.dish-diet-icons .diet-icon.gluten-free {
    background: #64B5F6;
}


.dish-image {
    width: 100%;
    height: 180px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--rouge-brique);
    background: var(--jaune-creme);
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1); /* Ombre interne sur l'image */
}
.dish-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
}
.dish-image:hover img {
    transform: scale(1.08); /* Zoom plus prononcé */
}

.dish-title {
    font-family: 'Playfair Display', serif; /* Police de titre pour les plats */
    font-size: var(--font-md);
    font-weight: 700;
    color: var(--rouge-brique);
    margin-bottom: 8px;
    line-height: 1.2;
}

.dish-nutritional {
    font-size: var(--font-xxs); /* Plus petite et discrète */
    color: var(--text-dark);
    opacity: 0.7;
    margin-bottom: 10px;
}

.dish-description {
    font-size: var(--font-xxs); /* Taille de texte pour la description */
    color: var(--text-dark);
    line-height: 1.5;
    margin-bottom: 12px;
    flex-grow: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dish-info {
    border-top: 1px dashed var(--border-color);
    padding-top: 12px;
    margin-top: 8px;
    font-size: var(--font-xxs); /* Taille de texte pour les infos */
    color: var(--text-dark);
}
.dish-info div {
    margin-bottom: 5px;
}
.dish-info strong {
    color: var(--rouge-doux);
}
.dish-info .fas {
    margin-right: 5px;
    color: var(--rouge-vif); /* Icônes en rouge vif */
}

.dish-price {
    font-size: var(--font-sm);
    font-weight: 700;
    color: var(--rouge-brique);
    margin-top: 15px;
    text-align: right;
}
.dish-price .fas {
    margin-right: 5px;
    color: var(--jaune-creme);
}


/* --- Système d'avis --- */
.rating-section {
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
    margin-top: 15px;
    background: rgba(255, 255, 255, 0.8);
    padding: 15px;
    border-radius: 8px;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
}
.rating-section h4 {
    font-size: var(--font-xxs);
    color: var(--text-dark);
    margin-bottom: 10px;
}

.stars {
    display: flex;
    gap: 3px;
    margin-bottom: 10px;
}

.star {
    color: #FFD700; /* Or */
    font-size: 1.5rem; /* Taille légèrement plus grande */
    cursor: pointer;
    transition: transform 0.2s ease, text-shadow 0.2s ease, color 0.2s ease;
}
.star:hover {
    transform: scale(1.2); /* Zoom plus prononcé au survol */
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); /* Ombre lumineuse */
    color: #FFEA00; /* Légèrement plus clair au survol */
}
.star i {
    pointer-events: none; /* Permet au clic d'être sur le span .star */
}

.comment-box {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--background-light);
    color: var(--text-dark);
    font-size: var(--font-xxs);
    resize: vertical;
    min-height: 50px;
    margin-bottom: 10px;
    transition: border-color 0.2s ease;
}
.comment-box:focus {
    outline: none;
    border-color: var(--rouge-doux);
}
.comment-box::placeholder {
    color: rgba(44, 26, 26, 0.5);
}

.submit-comment {
    padding: 10px 18px;
    border-radius: 20px;
    background: var(--rouge-brique);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: var(--font-xxs);
    transition: background 0.3s ease, transform 0.2s ease;
    box-shadow: 0 4px 10px var(--shadow-medium);
}

.submit-comment:hover {
    background: var(--rouge-doux);
    transform: translateY(-2px);
}
.submit-comment:disabled {
    background: #ccc;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}


/* --- Chargement & Hors-ligne --- */
.loading {
    text-align: center;
    padding: 50px;
    color: var(--text-dark);
    font-size: var(--font-sm);
}
.spinner {
    width: 45px;
    height: 45px;
    border: 5px solid rgba(139, 35, 35, 0.2);
    border-top: 5px solid var(--rouge-brique);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.offline-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--rouge-brique);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: var(--font-xs);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 5px 15px var(--shadow-dark);
}
.offline-indicator .fas {
    font-size: 1.1rem;
}

.no-results-message {
    text-align: center;
    padding: 50px;
    font-size: var(--font-sm);
    color: var(--rouge-doux);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
.no-results-message .fas {
    font-size: 3rem;
    color: var(--rouge-brique);
}


/* --- Utilitaires --- */
.hidden {
    display: none !important;
}

/* --- Modal de Zoom d'Image --- */
.image-zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.image-zoom-modal.active {
    opacity: 1;
    visibility: visible;
}
.modal-image {
    max-width: 90%;
    max-height: 90%;
    border-radius: 15px;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Animation plus "rebondissante" */
}
.image-zoom-modal.active .modal-image {
    transform: scale(1);
}
.close-modal-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    cursor: pointer;
    z-index: 2001;
    transition: transform 0.2s ease, color 0.2s ease;
}
.close-modal-btn:hover {
    transform: rotate(90deg);
    color: var(--rouge-vif);
}

/* --- Nouvelle modale de détails du plat --- */
.dish-detail-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1500;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.dish-detail-modal.active {
    opacity: 1;
    visibility: visible;
}

.dish-detail-modal .modal-content {
    background: var(--card-background);
    border-radius: 15px;
    max-width: 750px; /* Légèrement plus large */
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    padding: 30px;
    box-shadow: 0 10px 40px var(--shadow-dark);
    transform: translateY(20px);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Animation "rebondissante" */
}
.dish-detail-modal.active .modal-content {
    transform: translateY(0);
}

.dish-detail-modal .close-detail-modal-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    color: var(--text-dark);
    font-size: 30px;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
}
.dish-detail-modal .close-detail-modal-btn:hover {
    color: var(--rouge-brique);
    transform: rotate(90deg);
}

.detail-header {
    text-align: center;
    margin-bottom: 25px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 20px;
}
.detail-header img {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px var(--shadow-light);
}
.detail-header h2 {
    font-family: 'Playfair Display', serif; /* Police de titre */
    font-size: var(--font-lg); /* Plus grand */
    color: var(--rouge-brique);
    margin-bottom: 10px;
    line-height: 1.2;
}
.detail-header p {
    font-size: var(--font-xs);
    color: var(--text-dark);
    line-height: 1.6;
}
.detail-header .detail-price {
    font-size: var(--font-md);
    font-weight: bold;
    color: var(--rouge-brique);
    margin-top: 15px;
}
.detail-header .detail-dish-nutritional {
    font-size: var(--font-xxs); /* Taille discrète */
    color: var(--text-dark);
    opacity: 0.7;
    margin-bottom: 5px;
}

.detail-body {
    padding: 0 10px;
}
.detail-body p {
    margin-bottom: 15px;
    font-size: var(--font-xs);
    line-height: 1.6;
    color: var(--text-dark);
}

.detail-info-section, .detail-allergens-section {
    background: var(--background-light);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
}
.detail-info-section h3, .detail-allergens-section h3 {
    font-size: var(--font-sm);
    color: var(--rouge-doux);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600; /* Plus de poids */
}
.detail-info-section p {
    font-size: var(--font-xxs); /* Taille de texte pour les infos */
    margin-bottom: 8px;
    color: var(--text-dark);
}

.detail-allergens-section ul {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.detail-allergens-section li {
    background: var(--jaune-creme);
    color: var(--rouge-brique);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}
.detail-allergens-section li .fas {
    font-size: 0.9em;
    color: var(--rouge-vif); /* Icônes en rouge vif */
}

.detail-rating {
    background: transparent;
    box-shadow: none;
    padding: 0;
    border-top: none;
    margin-top: 0;
}
.detail-rating h4 {
    margin-top: 20px;
    text-align: left;
    font-size: var(--font-sm);
}

/* --- Animations de fond (particules) --- */
.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: var(--rouge-doux);
    border-radius: 50%;
    opacity: 0.5;
    box-shadow: 0 0 12px var(--rouge-doux);
    pointer-events: none;
    z-index: 0;
}
/* Les animations de float seront appliquées par JS */

/* --- Responsive Design --- */
@media (max-width: 992px) {
    .main-wrapper {
        flex-direction: column;
        max-width: 100%;
        box-shadow: none;
    }
    .sidebar {
        width: 100%;
        position: relative;
        height: auto;
        border-right: none;
        border-bottom: var(--glass-border);
        padding: 20px;
    }
    .sidebar .header {
        text-align: center;
    }
    .sidebar .header .logo-title {
        font-size: var(--font-lg);
    }
    .etablissement-info-card,
    .qr-section {
        margin-bottom: 20px;
    }
    .etablissement-info-card h3,
    .qr-section h3 {
        justify-content: center;
    }
    .etablissement-info-card p {
        text-align: center;
    }

    .content-area {
        padding: 0;
    }

    .top-banner {
        padding: 40px 20px;
        margin-bottom: 20px;
    }
    .top-banner h1 {
        font-size: var(--font-md);
    }
    .top-banner p {
        font-size: var(--font-xxs);
    }

    .nav-container {
        padding: 15px 10px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    .sub-nav {
        order: 2;
        flex-basis: 100%;
        margin-top: 15px;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        padding-bottom: 0;
    }
    .sub-nav.expanded {
        max-height: 300px;
        opacity: 1;
        padding-bottom: 10px;
    }
    .sub-nav .nav-items {
        justify-content: center;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 8px 15px;
        font-size: 0.8rem;
    }
    .filter-toggle {
        display: block;
        order: 1;
        flex-grow: 1;
        text-align: center;
    }
    .mobile-filter-toggle-btn {
        margin-right: 0;
    }


    .search-container {
        padding: 15px 20px;
        position: static;
    }
    .clear-search-btn {
        right: 30px;
    }

    #menuSectionsContainer {
        padding: 20px;
    }
    .menu-section h2 {
        font-size: var(--font-md);
    }
    .menu-grid {
        grid-template-columns: 1fr;
    }
    .dish-title {
        font-size: 1.25rem;
    }
    .dish-price {
        font-size: 1.1rem;
    }
    .offline-indicator {
        font-size: 0.8rem;
        padding: 8px 15px;
        top: 15px;
        right: 15px;
    }
    .close-modal-btn {
        font-size: 30px;
        top: 15px;
        right: 15px;
    }

    /* Modale de détails sur mobile */
    .dish-detail-modal .modal-content {
        width: 95%;
        padding: 20px;
        border-radius: 10px;
    }
    .dish-detail-modal .close-detail-modal-btn {
        font-size: 25px;
        top: 10px;
        right: 15px;
    }
    .detail-header img {
        max-height: 200px;
    }
    .detail-header h2 {
        font-size: var(--font-md);
    }
    .detail-header p {
        font-size: var(--font-xs);
    }
    .detail-info-section, .detail-allergens-section {
        padding: 15px;
    }
    .detail-info-section h3, .detail-allergens-section h3 {
        font-size: var(--font-xs);
        margin-bottom: 10px;
    }
    .detail-allergens-section li {
        font-size: 0.75rem;
        padding: 5px 10px;
    }
}
</style>
</head>

<body>
    <div class="offline-indicator hidden" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> Mode hors-ligne activé
    </div>

    <div class="main-wrapper">
        <aside class="sidebar">
            <header class="header">
                <h1 class="logo-title" id="menuTitle">Menu du Restaurant</h1>
                <p id="menuDescription">Découvrez nos délices culinaires</p>
            </header>

            <section class="etablissement-info-card" id="etablissementInfo">
                <h3><i class="fas fa-building"></i> Infos Établissement</h3>
                </section>

            <section class="qr-section">
                <h3><i class="fas fa-qrcode"></i> QR Code Menu</h3>
                <div class="qr-code" id="qrCodeContainer">
                    <span><i class="fas fa-qrcode"></i></span>
                </div>
            </section>
        </aside>

        <main class="content-area">
            <div class="top-banner" data-ga-dmt="header_bm">
                <div class="vcenter">
                    <h1 id="bannerTitle">Notre Menu</h1>
                    <p id="bannerDescription">Craving PERi-PERi? You’ve come to the right place!</p>
                    <p class="cta-container">
                        <a class="cta-button" <i class="fas fa-chevron-down"></i> Voir le menu</a>
                    </p>
                </div>
            </div>

            <div class="nav-container">
                <nav class="sub-nav" id="subNavCategories">
                    <div class="inner">
                        <div class="nav-items" id="filtersContainer">
                            <button class="filter-btn active" data-filter="all" data-filter-type="category">Tous les plats</button>
                            </div>
                    </div>
                </nav>
                <div class="filter-toggle">
                    <button class="mobile-filter-toggle-btn" id="mobileFilterToggleButton"><i class="fas fa-sliders-h"></i> Filtres</button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Rechercher un plat, ingrédient..." id="searchInput">
                <button class="clear-search-btn hidden" id="clearSearchBtn"><i class="fas fa-times"></i></button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                Chargement du menu...
            </div>

            <div id="menuSectionsContainer">
                </div>

            <p class="no-results-message hidden" id="noResultsMessage">
                <i class="fas fa-search-minus"></i> Aucun plat trouvé correspondant à votre recherche et vos filtres.
            </p>

        </main>
    </div>

    <div class="image-zoom-modal" id="imageZoomModal">
        <span class="close-modal-btn"><i class="fas fa-times-circle"></i></span>
        <img class="modal-image" id="modalImage" src="" alt="Image agrandie">
    </div>

    <div class="dish-detail-modal hidden" id="dishDetailModal">
        <div class="modal-content">
            <span class="close-detail-modal-btn"><i class="fas fa-times-circle"></i></span>
            <div class="detail-header">
                <img id="detailDishImage" src="" alt="Image du plat">
                <h2 id="detailDishTitle"></h2>
                <p id="detailDishNutritional"></p>
                <p class="detail-price" id="detailDishPrice"></p>
            </div>
            <div class="detail-body">
                <p id="detailDishDescription"></p>
                <div class="detail-info-section">
                    <h3><i class="fas fa-info-circle"></i> Informations Complémentaires</h3>
                    <p id="detailDishPrepTime"></p>
                    <p id="detailDishAvailability"></p>
                    <p id="detailDishTags"></p>
                </div>
                <div class="detail-allergens-section">
                    <h3><i class="fas fa-allergies"></i> Allergènes Potentiels</h3>
                    <ul id="detailDishAllergensList">
                        </ul>
                </div>
                <div class="rating-section detail-rating">
                    <h4>Votre avis:</h4>
                    <div class="stars" data-item-id="">
                        <span class="star" data-value="1"><i class="far fa-star"></i></span>
                        <span class="star" data-value="2"><i class="far fa-star"></i></span>
                        <span class="star" data-value="3"><i class="far fa-star"></i></span>
                        <span class="star" data-value="4"><i class="far fa-star"></i></span>
                        <span class="star" data-value="5"><i class="far fa-star"></i></span>
                    </div>
                    <textarea class="comment-box" placeholder="Laissez un commentaire..."></textarea>
                    <button class="submit-comment"><i class="fas fa-paper-plane"></i> Soumettre l'avis</button>
                </div>
            </div>
        </div>
    </div>


    <script >(function() {
    // --- Configuration API ---
     //const API_BASE_URL = 'http://127.0.0.1:8000'; // Votre URL de base
    const API_BASE_URL = "https://dailymenu.onrender.com"; // Si déployé

    // Extrait menu_id depuis l'URL (amélioré pour être plus robuste)
    const getMenuIdFromUrl = () => {
        const path = window.location.pathname;
        const match = path.match(/\/menus\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);
        return match ? match[1] : '5a4b4b60-b0e8-4c8d-98d5-f93849c4fa32'; // Valeur par défaut
    };
    const MENU_ID = getMenuIdFromUrl();

    // --- Variables Globales (pour le cache et les données) ---
    let menuData = null;
    let allItems = [];
    let categories = [];
    let allergenes = [];
    let activeAllergeneFilters = new Set(); // Pour le filtrage multiple des allergènes
    let activeCategoryFilter = 'all'; // Pour le filtre de catégorie (un seul à la fois)


    // --- Références DOM Caching ---
    const loadingElement = document.getElementById('loading');
    const menuSectionsContainer = document.getElementById('menuSectionsContainer');
    const offlineIndicator = document.getElementById('offlineIndicator');
    const menuTitleElement = document.getElementById('menuTitle');
    const menuDescriptionElement = document.getElementById('menuDescription');
    const etablissementInfoElement = document.getElementById('etablissementInfo');
    const qrCodeContainer = document.getElementById('qrCodeContainer');
    const filtersContainer = document.getElementById('filtersContainer');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const noResultsMessage = document.getElementById('noResultsMessage');

    // Nouveaux éléments pour la bannière et la sous-navigation
    const bannerTitleElement = document.getElementById('bannerTitle');
    const bannerDescriptionElement = document.getElementById('bannerDescription');
    const subNavCategories = document.getElementById('subNavCategories');
    const mobileFilterToggleButton = document.getElementById('mobileFilterToggleButton');

    // Modale de zoom d'image
    const imageZoomModal = document.getElementById('imageZoomModal');
    const modalImage = document.getElementById('modalImage');
    const closeModalBtn = imageZoomModal.querySelector('.close-modal-btn');

    // Nouvelle modale de détails du plat
    const dishDetailModal = document.getElementById('dishDetailModal');
    const closeDetailModalBtn = dishDetailModal.querySelector('.close-detail-modal-btn');
    const detailDishImage = document.getElementById('detailDishImage');
    const detailDishTitle = document.getElementById('detailDishTitle');
    const detailDishNutritional = document.getElementById('detailDishNutritional');
    const detailDishPrice = document.getElementById('detailDishPrice');
    const detailDishDescription = document.getElementById('detailDishDescription');
    const detailDishPrepTime = document.getElementById('detailDishPrepTime');
    const detailDishAvailability = document.getElementById('detailDishAvailability');
    const detailDishTags = document.getElementById('detailDishTags');
    const detailDishAllergensList = document.getElementById('detailDishAllergensList');
    const detailRatingSection = dishDetailModal.querySelector('.detail-rating');


    // --- Fonctions Utilitaires ---

    // Fonction pour retenter la requête API avec un délai croissant
    async function fetchWithRetry(url, retries = 3, delay = 1000) {
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Menu non trouvé (404) pour l'ID: ${MENU_ID}`);
                    }
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.warn(`Tentative ${attempt}/${retries} échouée pour ${url}: ${error.message}`);
                if (attempt === retries) throw error;
                await new Promise(resolve => setTimeout(resolve, delay * attempt));
            }
        }
    }

    // Affiche/Masque un élément avec une classe 'hidden'
    const toggleVisibility = (element, show) => {
        if (element) {
            element.classList.toggle('hidden', !show);
        }
    };

    // --- Chargement des Données du Menu ---
    async function loadMenuData() {
        toggleVisibility(loadingElement, true);
        toggleVisibility(menuSectionsContainer, false);
        toggleVisibility(noResultsMessage, false);
        toggleVisibility(offlineIndicator, false);

        try {
            const data = await fetchWithRetry(`${API_BASE_URL}/api/api/public/menu/${MENU_ID}`);
           
            menuData = data.menu || {};
            allItems = data.menu.items || [];
            categories = data.categories || [];
            allergenes = data.allergenes || [];
            const etablissement = data.etablissement || {};
            const qrcodeUrl = data.qrcode;
            
            // Stocker dans localStorage pour le mode hors-ligne
            localStorage.setItem('menuCache', JSON.stringify(data));

            // Mise à jour de l'interface
            updateMenuHeader(menuData);
            updateEtablissementInfo(etablissement);
            updateQRCode(qrcodeUrl);
            updateBanner(menuData);
            generateFilterButtons(); // Renommé pour plus de clarté
            displayMenuSections();

            toggleVisibility(loadingElement, false);
            toggleVisibility(menuSectionsContainer, true);

        } catch (error) {
            console.error('Erreur lors du chargement du menu:', error);
            const cachedData = localStorage.getItem('menuCache');
            if (cachedData) {
                const data = JSON.parse(cachedData);
                menuData = data.menu || {};
                allItems = data.menu.items || [];
                categories = data.categories || [];
                allergenes = data.allergenes || [];
                const etablissement = data.etablissement || {};
                const qrcodeUrl = data.qrcode;

                updateMenuHeader(menuData);
                updateEtablissementInfo(etablissement);
                updateQRCode(qrcodeUrl);
                updateBanner(menuData);
                generateFilterButtons();
                displayMenuSections();

                toggleVisibility(loadingElement, false);
                toggleVisibility(menuSectionsContainer, true);
                toggleVisibility(offlineIndicator, true);
            } else {
                loadingElement.innerHTML = `
                    <div style="color: var(--rouge-brique); text-align: center;">
                        <p><i class="fas fa-exclamation-triangle"></i> Une erreur est survenue lors du chargement du menu.</p>
                        <p><small>Vérifiez votre connexion ou l'ID du menu et réessayez plus tard.</small></p>
                        <p><small>Détail de l'erreur: ${error.message}</small></p>
                    </div>
                `;
                toggleVisibility(loadingElement, true);
            }
        }
    }

    // --- Mise à jour de l'interface utilisateur ---

    function updateMenuHeader(data) {
        menuTitleElement.textContent = `${data.nom || 'Menu du Restaurant'}`;
        menuDescriptionElement.textContent = data.description || 'Votre expérience culinaire';
    }

    function updateBanner(data) {
        bannerTitleElement.textContent = data.nom || 'Notre Menu';
        bannerDescriptionElement.textContent = data.description || 'Découvrez nos saveurs uniques !';
    }

    function updateEtablissementInfo(etablissement) {
        if (!etablissementInfoElement) return;

        const nom = etablissement.nom_etablissement || 'Nom non disponible';
        const adresse = etablissement.adresse_physique || 'Adresse non disponible';
        const telephone = etablissement.numtel || 'Numéro non disponible';
        const email = etablissement.email_pro || 'Email non disponible';

        etablissementInfoElement.innerHTML = `
            <h3><i class="fas fa-building"></i> Infos Établissement</h3>
            <p><i class="fas fa-store"></i> <strong>Nom:</strong> ${nom}</p>
            <p><i class="fas fa-map-marker-alt"></i> <strong>Adresse:</strong> ${adresse}</p>
            <p><i class="fas fa-phone"></i> <strong>Tel:</strong> ${telephone}</p>
            <p><i class="fas fa-envelope"></i> <strong>Email:</strong> ${email}</p>
        `
    }

    function updateQRCode(qrcodeUrl) {
       
        if (qrcodeUrl) {
            qrCodeContainer.innerHTML = `<img src="${qrcodeUrl}" alt="QR Code du menu">`;
        } else {
            qrCodeContainer.innerHTML = '<span><i class="fas fa-qrcode"></i> Pas de QR code</span>';
        }
    }

    function generateFilterButtons() {
        filtersContainer.innerHTML = ''; // Nettoyer tous les filtres

        // Bouton "Tous les plats"
        const allButton = document.createElement('button');
        allButton.className = `filter-btn ${activeCategoryFilter === 'all' ? 'active' : ''}`;
        allButton.dataset.filter = 'all';
        allButton.dataset.filterType = 'category';
        allButton.textContent = 'Tous les plats';
        filtersContainer.appendChild(allButton);

        // Boutons de catégorie
        const sortedCategories = [...categories].sort((a, b) => a.name.localeCompare(b.name));
        sortedCategories.forEach(category => {
            const button = document.createElement('button');
            button.className = `filter-btn ${activeCategoryFilter === category.name.toLowerCase() ? 'active' : ''}`;
            button.dataset.filter = category.name.toLowerCase();
            button.dataset.filterType = 'category';
            button.textContent = category.name.charAt(0).toUpperCase() + category.name.slice(1);
            filtersContainer.appendChild(button);
        });

        // Boutons allergènes
        const sortedAllergenes = [...allergenes].sort((a, b) => a.nom_allergene.localeCompare(b.nom_allergene));
        sortedAllergenes.forEach(allergene => {
            const button = document.createElement('button');
            const allergeneKey = `allergene-${allergene.nom_allergene.toLowerCase()}`;
            button.className = `filter-btn ${activeAllergeneFilters.has(allergeneKey) ? 'active' : ''}`;
            button.dataset.filter = allergeneKey;
            button.dataset.filterType = 'allergene';
            button.textContent = `Sans ${allergene.nom_allergene}`;
            filtersContainer.appendChild(button);
        });

        attachFilterEvents();
    }

    function displayMenuSections() {
        menuSectionsContainer.innerHTML = '';
        toggleVisibility(noResultsMessage, false);

        const itemsByCategory = {};
        allItems.forEach(item => {
            const categoryNames = item.categories.length > 0 ? item.categories.map(cat => cat.name) : ['Autres'];
            categoryNames.forEach(catName => {
                if (!itemsByCategory[catName]) {
                    itemsByCategory[catName] = [];
                }
                itemsByCategory[catName].push(item);
            });
        });

        const orderedCategoryNames = categories.length > 0
            ? categories.map(cat => cat.name)
            : Object.keys(itemsByCategory).sort();

        orderedCategoryNames.forEach(categoryName => {
            const categoryItems = itemsByCategory[categoryName];
            if (categoryItems && categoryItems.length > 0) {
                const section = document.createElement('section');
                section.className = 'menu-section';
                section.id = `section_${categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
                section.innerHTML = `<h2><em>${categoryName}</em></h2><div class="menu-grid"></div>`;

                const grid = section.querySelector('.menu-grid');
                const fragment = document.createDocumentFragment();

                const sortedItems = [...categoryItems].sort((a, b) => {
                    // Trier les articles disponibles en premier, puis alphabétiquement
                    if (a.disponibilite && !b.disponibilite) return -1;
                    if (!a.disponibilite && b.disponibilite) return 1;
                    return a.nom_plat.localeCompare(b.nom_plat);
                });

                sortedItems.forEach(item => {
                    const dishCard = createDishCard(item);
                    fragment.appendChild(dishCard);
                });

                grid.appendChild(fragment);
                menuSectionsContainer.appendChild(section);
            }
        });

        applyFiltersAndSearch();
    }

    function createDishCard(item) {
        const card = document.createElement('div');
        card.className = 'dish-card';
        if (!item.disponibilite) {
            card.classList.add('unavailable-item');
        }
        // Ajout des data-attributs pour le filtrage
        card.dataset.category = (item.categories || []).map(cat => cat.name.toLowerCase()).join(' ');
        card.dataset.allergenes = (item.ingredients || []).flatMap(ing => (ing.allergenes || []).map(a => a.nom_allergene.toLowerCase())).join(' ');
        card.dataset.itemId = item.id_item || `item-${Date.now()}`;

        const imageUrl = item.images && item.images.length > 0 ? `${API_BASE_URL}${item.images[0].url_image}` : null;
        const price = item.price ? parseFloat(item.price).toFixed(0) : 'N/A';
        const prepTime = item.prep_time || 'N/A';
        const description = item.description || 'Aucune description disponible.';
        const nomPlat = item.nom_plat || 'Plat sans nom';
        const tags = (item.tags || []).map(tag => tag.name.toLowerCase());

        const nutritionalInfo = item.nutritional_info || '';

        let flagsHtml = '';
        if (tags.includes('nouveau') || tags.includes('new')) {
            flagsHtml += '<i class="flag new">new</i>';
        }
        if (tags.includes('populaire') || tags.includes('featured')) {
            flagsHtml += '<i class="flag featured">POPULAIRE</i>';
        }

        let dietIconsHtml = '';
        if (tags.includes('vegetarien') || tags.includes('vegetarian')) {
            dietIconsHtml += '<span class="diet-icon vegetarian">Végétarien</span>';
        }
        if (tags.includes('vegan') || tags.includes('plant-based')) {
            dietIconsHtml += '<span class="diet-icon vegan">Vegan</span>';
        }
        // Exemple d'ajout d'autres tags comme "Sans gluten" si vos données le contiennent
        if (tags.includes('sans gluten') || tags.includes('gluten-free')) {
            dietIconsHtml += '<span class="diet-icon gluten-free">Sans Gluten</span>';
        }

        let joursDispoHtml = '';
        if (item.jours_disponibilite && item.jours_disponibilite.length > 0) {
            const jours = item.jours_disponibilite.map(jour => jour.nom).join(', ');
            joursDispoHtml = `<div><i class="fas fa-calendar-alt"></i> <strong>Jours:</strong> ${jours}</div>`;
        }

        let additionalTagsHtml = '';
        const relevantTags = tags.filter(t => !['nouveau', 'new', 'populaire', 'featured', 'vegetarien', 'vegetarian', 'vegan', 'plant-based', 'sans gluten', 'gluten-free'].includes(t));
        if (relevantTags.length > 0) {
            additionalTagsHtml = `<div><i class="fas fa-tag"></i> <strong>Tags:</strong> ${relevantTags.join(', ')}</div>`;
        }

        card.innerHTML = `
            ${flagsHtml}
            <div class="dish-image">
                ${imageUrl ? `<img src="${imageUrl}" alt="${nomPlat}">` : '<span><i class="fas fa-utensils"></i></span>'}
            </div>
            <h3 class="dish-title">${nomPlat}</h3>
            ${nutritionalInfo ? `<div class="dish-nutritional">${nutritionalInfo}</div>` : ''}
            <p class="dish-description">${description}</p>
            <div class="dish-info">
                <div><i class="fas fa-hourglass-half"></i> <strong>Préparation:</strong> ${prepTime} min</div>
                ${joursDispoHtml}
                ${additionalTagsHtml}
            </div>
            <div class="dish-price">${price} FCFA</div>
            <div class="dish-diet-icons">${dietIconsHtml}</div>
            <div class="rating-section">
                <h4>Votre avis:</h4>
                <div class="stars" data-item-id="${card.dataset.itemId}">
                    <span class="star" data-value="1"><i class="far fa-star"></i></span>
                    <span class="star" data-value="2"><i class="far fa-star"></i></span>
                    <span class="star" data-value="3"><i class="far fa-star"></i></span>
                    <span class="star" data-value="4"><i class="far fa-star"></i></span>
                    <span class="star" data-value="5"><i class="far fa-star"></i></span>
                </div>
                <textarea class="comment-box" placeholder="Laissez un commentaire sur ${nomPlat}..."></textarea>
                <button class="submit-comment"><i class="fas fa-paper-plane"></i> Soumettre l'avis</button>
            </div>
        `;

        const dishImageDiv = card.querySelector('.dish-image');
        if (imageUrl) {
            dishImageDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                zoomImage(imageUrl);
            });
        }
        setupRatingForCard(card);

        // Ouvre la modale de détails du plat au clic sur la carte
        card.addEventListener('click', (e) => {
            // S'assurer que le clic n'est pas sur le système de notation ou l'image de zoom
            if (!e.target.closest('.rating-section') && !e.target.closest('.dish-image') && item.disponibilite) {
                openDishDetailModal(item);
            }
        });

        return card;
    }

    // --- Gestion des Filtres et de la Recherche ---

    function attachFilterEvents() {
        filtersContainer.querySelectorAll('.filter-btn').forEach(btn => {
            btn.onclick = null; // Supprime les anciens listeners
            btn.addEventListener('click', function() {
                const filterType = this.dataset.filterType;
                const filterValue = this.dataset.filter;

                if (filterType === 'category') {
                    // Désactiver tous les autres filtres de catégorie
                    filtersContainer.querySelectorAll('.filter-btn[data-filter-type="category"]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    activeCategoryFilter = filterValue;
                } else if (filterType === 'allergene') {
                    // Activer/désactiver l'allergène
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        activeAllergeneFilters.add(filterValue);
                    } else {
                        activeAllergeneFilters.delete(filterValue);
                    }
                }

                // Fermer la sous-nav sur mobile si elle est ouverte et qu'on a cliqué un filtre
                if (window.innerWidth <= 992 && subNavCategories.classList.contains('expanded')) {
                    toggleMobileFilters();
                }

                applyFiltersAndSearch();
                scrollToTopBanner();
            });
        });
    }

    function applyFiltersAndSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let hasVisibleItems = false;

        document.querySelectorAll('.menu-section').forEach(section => {
            let sectionHasVisibleItems = false;
            const dishes = section.querySelectorAll('.dish-card');

            dishes.forEach(dish => {
                const title = dish.querySelector('.dish-title').textContent.toLowerCase();
                const descriptionElement = dish.querySelector('.dish-description');
                const description = descriptionElement ? descriptionElement.textContent.toLowerCase() : '';
                const infoTextElement = dish.querySelector('.dish-info');
                const infoText = infoTextElement ? infoTextElement.textContent.toLowerCase() : '';

                const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm) || infoText.includes(searchTerm);

                // Vérification du filtre de catégorie (un seul actif)
                const dishCategories = dish.dataset.category.split(' ').filter(c => c);
                const matchesCategory = activeCategoryFilter === 'all' || dishCategories.includes(activeCategoryFilter);

                // Vérification des filtres allergènes (tous les actifs doivent correspondre)
                let matchesAllergenes = true;
                if (activeAllergeneFilters.size > 0) {
                    const dishAllergenes = dish.dataset.allergenes.split(' ').filter(a => a);
                    // Pour chaque allergène actif dans les filtres, le plat NE DOIT PAS contenir cet allergène
                    for (let filterAllergene of activeAllergeneFilters) {
                        const allergeneName = filterAllergene.replace('allergene-', '');
                        if (dishAllergenes.includes(allergeneName)) {
                            matchesAllergenes = false; // Le plat contient un allergène qu'on veut exclure
                            break;
                        }
                    }
                }

                const shouldShow = matchesSearch && matchesCategory && matchesAllergenes;
                toggleVisibility(dish, shouldShow);

                if (shouldShow) {
                    sectionHasVisibleItems = true;
                    hasVisibleItems = true;
                }
            });

            toggleVisibility(section, sectionHasVisibleItems);
        });

        toggleVisibility(noResultsMessage, !hasVisibleItems);
    }

    function setupSearch() {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            toggleVisibility(clearSearchBtn, searchTerm.length > 0);
            applyFiltersAndSearch();
        });

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            toggleVisibility(clearSearchBtn, false);
            applyFiltersAndSearch();
        });
    }

    function scrollToTopBanner() {
        const topBanner = document.querySelector('.top-banner');
        if (topBanner) {
            topBanner.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // --- Zoom d'Image (Modal) ---
    function zoomImage(imageUrl) {
        modalImage.src = imageUrl;
        imageZoomModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeZoomModal() {
        imageZoomModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    closeModalBtn.addEventListener('click', closeZoomModal);
    imageZoomModal.addEventListener('click', (event) => {
        if (event.target === imageZoomModal || event.target.closest('.close-modal-btn')) {
            closeZoomModal();
        }
    });

    // --- Modale de Détails du Plat ---
    function openDishDetailModal(item) {
        const imageUrl = item.images && item.images.length > 0 ? `${API_BASE_URL}${item.images[0].url_image}` : '';
        const price = item.price ? parseFloat(item.price).toFixed(0) : 'N/A';
        const prepTime = item.prep_time || 'N/A';
        const description = item.description || 'Aucune description disponible.';
        const nomPlat = item.nom_plat || 'Plat sans nom';
        const nutritionalInfo = item.nutritional_info || '';
        const tags = (item.tags || []).map(tag => tag.name.toLowerCase());

        detailDishImage.src = imageUrl || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Image vide si pas d'URL
        detailDishImage.alt = nomPlat;
        detailDishTitle.textContent = nomPlat;
        detailDishNutritional.textContent = nutritionalInfo;
        detailDishPrice.textContent = `${price} FCFA`;
        detailDishDescription.textContent = description;
        detailDishPrepTime.innerHTML = `<i class="fas fa-hourglass-half"></i> <strong>Préparation:</strong> ${prepTime} min`;

        let joursDispoHtml = 'Non spécifié';
        if (item.jours_disponibilite && item.jours_disponibilite.length > 0) {
            joursDispoHtml = item.jours_disponibilite.map(jour => jour.nom).join(', ');
        }
        detailDishAvailability.innerHTML = `<i class="fas fa-calendar-alt"></i> <strong>Disponibilité:</strong> ${joursDispoHtml}`;

        const relevantTags = tags.filter(t => !['nouveau', 'new', 'populaire', 'featured', 'vegetarien', 'vegetarian', 'vegan', 'plant-based', 'sans gluten', 'gluten-free'].includes(t));
        detailDishTags.innerHTML = relevantTags.length > 0 ? `<i class="fas fa-tag"></i> <strong>Tags:</strong> ${relevantTags.join(', ')}` : '<i class="fas fa-tag"></i> <strong>Tags:</strong> Aucun';

        detailDishAllergensList.innerHTML = '';
        const allItemAllergenes = (item.ingredients || []).flatMap(ing => (ing.allergenes || []));
        if (allItemAllergenes.length > 0) {
            const uniqueAllergenes = [...new Set(allItemAllergenes.map(a => a.nom_allergene))];
            uniqueAllergenes.forEach(allergeneName => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${allergeneName.charAt(0).toUpperCase() + allergeneName.slice(1)}`;
                detailDishAllergensList.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'Aucun allergène majeur connu.';
            detailDishAllergensList.appendChild(li);
        }

        // Réinitialiser le système de notation pour la modale
        detailRatingSection.querySelector('.stars').dataset.itemId = item.id_item;
        detailRatingSection.querySelector('.comment-box').value = '';
        detailRatingSection.querySelector('.comment-box').readOnly = false;
        detailRatingSection.querySelector('.submit-comment').disabled = false;
        detailRatingSection.querySelectorAll('.star i').forEach(starIcon => starIcon.className = 'far fa-star');
        setupRatingForCard(detailRatingSection); // Ré-initialise la logique de notation pour la modale

        dishDetailModal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Empêche le défilement du body
    }

    function closeDishDetailModal() {
        dishDetailModal.classList.remove('active');
        document.body.style.overflow = ''; // Rétablit le défilement du body
    }

    closeDetailModalBtn.addEventListener('click', closeDishDetailModal);
    dishDetailModal.addEventListener('click', (event) => {
        if (event.target === dishDetailModal || event.target.closest('.close-detail-modal-btn')) {
            closeDishDetailModal();
        }
    });

   // --- Système de Notation et Commentaires ---
function setupRatingForCard(container) { // Prend le conteneur (carte ou modale)
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    let reviews = JSON.parse(localStorage.getItem('reviews')) || [];
    const starsContainer = container.querySelector('.stars');
    const itemId = starsContainer.dataset.itemId;
    const stars = starsContainer.querySelectorAll('.star');
    const commentBox = container.querySelector('.comment-box');
    const submitBtn = container.querySelector('.submit-comment');

    let currentRating = 0;

    const existingReview = reviews.find(r => r.itemId === itemId);
    if (existingReview) {
        currentRating = existingReview.rating;
        commentBox.value = existingReview.comment;
        stars.forEach((star, index) => {
            star.querySelector('i').className = index < currentRating ? 'fas fa-star' : 'far fa-star';
        });
        commentBox.readOnly = true;
        submitBtn.disabled = true;
    } else {
        commentBox.readOnly = false;
        submitBtn.disabled = false;
        commentBox.value = '';
        currentRating = 0; // Réinitialiser pour les nouvelles cartes
        stars.forEach(s => s.querySelector('i').className = 'far fa-star');
    }

    starsContainer.onmouseover = (event) => {
        if (commentBox.readOnly) return;
        const hoveredStar = event.target.closest('.star');
        if (hoveredStar) {
            const value = parseInt(hoveredStar.dataset.value);
            stars.forEach((star, index) => {
                star.querySelector('i').className = index < value ? 'fas fa-star' : 'far fa-star';
            });
        }
    };

    starsContainer.onmouseout = () => {
        if (commentBox.readOnly) return;
        stars.forEach((star, index) => {
            star.querySelector('i').className = index < currentRating ? 'fas fa-star' : 'far fa-star';
        });
    };

    stars.forEach((star) => {
        star.onclick = null; // Supprimer les anciens listeners
        star.addEventListener('click', function() {
            if (commentBox.readOnly) return;
            currentRating = parseInt(this.dataset.value);
            stars.forEach((s, i) => {
                s.querySelector('i').className = i < currentRating ? 'fas fa-star' : 'far fa-star';
            });
        });
    });

    submitBtn.onclick = null; // Supprimer les anciens listeners
    submitBtn.addEventListener('click', async () => {
        const comment = commentBox.value.trim();

        if (currentRating === 0 && !comment) {
            alert('Veuillez donner une note ou un commentaire.');
            return;
        }

        const existingReviewIndex = reviews.findIndex(r => r.itemId === itemId);
        if (existingReviewIndex !== -1) {
            alert('Vous avez déjà laissé un avis pour ce plat. Vous ne pouvez pas le modifier.');
            return;
        }

        const now = new Date();
        reviews.push({
            itemId,
            rating: currentRating,
            comment,
            timestamp: now.toISOString()
        });

        localStorage.setItem('reviews', JSON.stringify(reviews));

        // Préparer les données pour l'API
        const avisData = {
            id_item: itemId,                // ID de l'item
            note: currentRating,            // Note
            description: comment            // Commentaire
        };

        // Appel API pour soumettre l'avis
        try {
          const response = await fetch('/api/avis', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken  // Ajoutez cette ligne
    },
    body: JSON.stringify(avisData),
});
            if (response.ok) {
                const result = await response.json();
                alert(`Merci pour votre note de ${result.note} étoile(s) et votre commentaire !`);
            } else {
                const errorData = await response.json();
                alert('Erreur lors de l\'ajout de l\'avis: ' + errorData.error);
            }
        } catch (error) {
            console.error('Erreur de réseau:', error);
            alert('Erreur de réseau: ' + error.message);
        }

        // Réinitialiser le formulaire
        commentBox.value = '';
        currentRating = 0;
        stars.forEach(s => s.querySelector('i').className = 'far fa-star');
        commentBox.readOnly = true;
        submitBtn.disabled = true;
          location.reload();
    });
}
    // --- Détection du Réseau ---
    function setupNetworkDetection() {
        window.addEventListener('online', () => {
            toggleVisibility(offlineIndicator, false);
            if (menuData === null) {
                loadMenuData();
            }
        });
        window.addEventListener('offline', () => {
            toggleVisibility(offlineIndicator, true);
        });
    }

    // --- Gestion de la visibilité des filtres sur mobile ---
    function toggleMobileFilters() {
        if (subNavCategories) {
            subNavCategories.classList.toggle('expanded');
            mobileFilterToggleButton.classList.toggle('active');
        }
    }

    function setupMobileFiltersToggle() {
        if (mobileFilterToggleButton && subNavCategories) {
            mobileFilterToggleButton.addEventListener('click', toggleMobileFilters);

            // Cacher par défaut sur les petits écrans au chargement
            if (window.innerWidth <= 992) {
                subNavCategories.classList.remove('expanded'); // S'assurer qu'il est fermé
            }
        }
    }

    // --- Génération des particules ---
    function generateParticles(count) {
        document.querySelectorAll('.particle').forEach(p => p.remove());

        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animation = `float ${6 + Math.random() * 4}s ease-in-out infinite`;
            particle.style.animationDelay = `${Math.random() * 6}s`;
            document.body.appendChild(particle);
        }
        let styleSheet = document.getElementById('particle-animation-style');
        if (!styleSheet) {
            styleSheet = document.createElement("style");
            styleSheet.type = "text/css";
            styleSheet.id = "particle-animation-style";
            document.head.appendChild(styleSheet);
        }
        styleSheet.innerText = `@keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }`;
    }

    // --- Initialisation de l'Application ---
    document.addEventListener('DOMContentLoaded', function() {
        generateParticles(8);
        loadMenuData();
        setupSearch();
        setupNetworkDetection();
        setupMobileFiltersToggle();
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth > 992) {
            // Sur desktop, toujours montrer la sub-nav
            if (subNavCategories) subNavCategories.classList.remove('expanded');
            if (mobileFilterToggleButton) mobileFilterToggleButton.classList.remove('active');
        } else {
            // Sur mobile, cacher par défaut (si pas déjà ouvert par le bouton)
            if (subNavCategories && !mobileFilterToggleButton.classList.contains('active')) {
                subNavCategories.classList.remove('expanded');
            }
        }
    });

})();</script>
</body>
</html>